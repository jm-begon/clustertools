#!/usr/bin/env python

from __future__ import print_function

import time
import datetime
import argparse
import subprocess
import os
import socket
import sys
from collections import defaultdict
from clustertools import Monitor, Architecture

#TODO regular expression style

__author__ = "Begon Jean-Michel <jm.begon@gmail.com>"
__copyright__ = "3-clause BSD License"

__LH__ = "localhost"
__WC__ = "*"

if __name__ == "__main__":
    description = "Clustertools task monitoring script"
    doc = """The experiment(s) to monitor.
Use ssh-like syntax: 'luke@skywalker:exp_about_the_force'. The first part can
be omitted for local survey. A wildcard '%s' can be used to list all the
experiment. Several queries are separated by a space. Queries for a remote
host are sent as once. By default, all the local experiment are listed
""" % __WC__

    parser = argparse.ArgumentParser(description=description)
    parser.add_argument("queries", help=doc, nargs="*")
    parser.add_argument("-l", "--loop", default=-1, type=int,
                        help="Number of minute to wait between two "
                             "refreshment. Set to negative (default) for no "
                             "refreshment.")

    # =========== Preprocessing ============= #

    args = parser.parse_args()
    queries = args.queries
    if len(queries) == 0:
        queries = ["*"]

    # Sort query by host to group them
    sorted_queries = defaultdict(list)
    for query in queries:
        try:
            host, exp_name = query.split(":")
        except ValueError:
            host = __LH__
            exp_name = query
        sorted_queries[host].append(exp_name)

    # =========== Main ============= #

    def main():
        # Local queries
        try:
            hostname = socket.gethostname()
        except:
            hostname = "Unknown host"
        if __LH__ in sorted_queries:
            for exp_name in sorted_queries[__LH__]:
                if exp_name == __WC__:
                    print(hostname, ":")
                    for name in Architecture().load_experiment_names():
                        print("\t", name, Monitor(name).count_by_state())
                else:
                    print(hostname, ":", exp_name,
                          Monitor(exp_name).count_by_state())
            del sorted_queries[__LH__]

        # Remote queries
        cmd = "ssh {host} {prog} {exp}"
        prog = os.path.basename(sys.argv[0])
        for host, exp_names in sorted_queries.items():
            exp_string = " ".join(exp_names)
            act_cmd = cmd.format(host=host, exp=exp_string, prog=prog)
            subprocess.call(act_cmd, shell=True)

    if args.loop < 0:
        main()
    else:
        try:
            while True:
                os.system("clear")
                print(datetime.datetime.now().strftime("%A %d %h %Y %H:%M:%S"))
                main()
                time.sleep(args.loop*60)
        except (KeyboardInterrupt, SystemExit):
            print("")
